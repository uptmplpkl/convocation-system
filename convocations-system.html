<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Check-In Convocation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .export-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .export-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Import Excel Section */
        .import-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .import-title {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }

        .file-upload-area {
            border: 3px dashed #3498db;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .file-upload-area.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
            transform: scale(1.02);
        }

        .file-upload-area:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }

        .upload-icon {
            font-size: 4em;
            color: #3498db;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .upload-subtext {
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
        }

        .upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .template-download {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .template-btn {
            background: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .template-btn:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .preview-section {
            margin-top: 20px;
            display: none;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .preview-table th,
        .preview-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .preview-table th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }

        .preview-table tr:hover {
            background: #f8f9fa;
        }

        .import-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .import-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .import-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
        }

        .cancel-btn {
            background: #e74c3c;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: #c0392b;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Statistics Dashboard */
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-total { color: #2a5298; }
        .stat-hadir { color: #27ae60; }
        .stat-tidak-hadir { color: #e74c3c; }
        .stat-pending { color: #f39c12; }

        /* Main Interface */
        .main-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #1e3c72;
            margin-bottom: 25px;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Search Section */
        .search-bar {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #2a5298;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .filter-btn.active {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }

        .graduate-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .graduate-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .graduate-item:hover {
            background: #e3f2fd;
            border-color: #2a5298;
            transform: translateY(-2px);
        }

        .graduate-item.selected {
            background: #2a5298;
            color: white;
            border-color: #1e3c72;
        }

        .graduate-name {
            font-weight: 600;
            font-size: 1.2em;
            margin-bottom: 8px;
        }

        .graduate-details {
            font-size: 0.95em;
            opacity: 0.8;
        }

        .status-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-hadir {
            background: #d4edda;
            color: #155724;
        }

        .status-tidak-hadir {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        /* Check-in Form */
        .checkin-form {
            display: none;
        }

        .checkin-form.active {
            display: block;
        }

        .no-selection {
            text-align: center;
            padding: 50px 20px;
            color: #6c757d;
        }

        .graduate-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 2px solid #c3e6cb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .guest-section {
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        .guest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .guest-title {
            font-weight: 600;
            color: #1e3c72;
            font-size: 1.2em;
        }

        .attendance-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 25px;
            padding: 4px;
            border: 2px solid #ddd;
        }

        .toggle-option {
            padding: 12px 20px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 600;
            min-width: 100px;
            background: #f8f9fa;
            color: #495057;
        }

        .toggle-option.active {
            background: #27ae60;
            color: white;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            transform: scale(1.05);
        }

        .toggle-option.inactive {
            background: #e74c3c;
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            transform: scale(1.05);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e3c72;
            font-weight: 600;
            font-size: 1em;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            border-color: #2a5298;
            outline: none;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .form-group input:disabled {
            background: #e9ecef;
            color: #6c757d;
        }

        .replacement-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .replacement-section.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            display: block !important;
            visibility: visible !important;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .success-message {
            background: #d4edda;
            color: 155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #c3e6cb;
            display: none;
            font-weight: 600;
        }

        /* Attendance Log */
        .attendance-log {
            grid-column: 1 / -1;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .log-table th,
        .log-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .log-table th {
            background: #1e3c72;
            color: white;
            font-weight: 600;
        }

        .log-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-interface {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }

            .attendance-toggle {
                flex-direction: column;
                gap: 5px;
            }

            .toggle-option {
                text-align: center;
            }

            .template-download {
                flex-direction: column;
                align-items: center;
            }

            .import-controls {
                flex-direction: column;
                align-items: center;
            }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #27ae60;
            transition: width 0.3s ease;
            width: 0%;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Google Sheets Connection */
        .connection-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .connection-form {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .connection-input {
            flex: 1;
            min-width: 300px;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
        }

        .connection-input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .connection-btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .connection-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
        }

        .connection-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            display: none;
        }

        .connection-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .connection-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>Sistem Check-In Kehadiran Tetamu Convocation</h1>
            <p>Pusat Latihan Polis Kuala Lumpur</p>
            <button onclick="exportData()" class="export-btn" id="exportBtn" disabled>
                Export Data CSV
            </button>
        </div>

        <!-- GOOGLE SHEETS CONNECTION SECTION -->
        <div class="connection-section">
            <h2 class="import-title">Sambungan ke Google Sheets</h2>
            <div class="connection-form">
                <input type="text" id="sheetLink" class="connection-input" 
                       placeholder="https://docs.google.com/spreadsheets/d/..." 
                       value="https://docs.google.com/spreadsheets/d/1X5lR2VXvjwT6QnI9nZ4ZQ7a7bVc3dYyF/edit?usp=sharing">
                <button class="connection-btn" onclick="connectToSheet()">
                    Sambung ke Google Sheets
                </button>
            </div>
            <div class="connection-status" id="connectionStatus"></div>
        </div>

        <!-- IMPORT EXCEL SECTION -->
        <div class="import-section">
            <h2 class="import-title">Import Data dari Excel</h2>
            
            <div class="status-message" id="statusMessage"></div>
            <div class="loading" id="loadingDiv">
                <div class="loading-spinner"></div>
                <p>Sedang memproses fail Excel...</p>
            </div>
            
            <div class="file-upload-area" id="uploadArea">
                <div class="upload-icon">📄</div>
                <div class="upload-text">Drag & Drop fail Excel di sini</div>
                <div class="upload-subtext">atau klik butang di bawah untuk pilih fail (Max: 10MB)</div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                <button class="upload-btn" onclick="selectFile()" id="uploadBtn">
                    Pilih Fail Excel
                </button>
                <div class="progress-bar" id="progressBar" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="template-download">
                <button class="template-btn" onclick="downloadTemplate()">
                    Download Template Excel
                </button>
                <button class="template-btn" onclick="showFormatExample()">
                    Lihat Format Contoh
                </button>
            </div>

            <div class="preview-section" id="previewSection">
                <h3>Preview Data (5 baris pertama):</h3>
                <div style="overflow-x: auto;">
                    <table class="preview-table" id="previewTable"></table>
                </div>
                <div class="import-controls">
                    <button class="import-btn" onclick="importData()">
                        Import Data
                    </button>
                    <button class="cancel-btn" onclick="cancelPreview()">
                        Batal
                    </button>
                </div>
            </div>
        </div>

        <!-- STATISTICS DASHBOARD -->
        <div class="statistics">
            <div class="stat-card">
                <div class="stat-number stat-total" id="totalGraduates">0</div>
                <div class="stat-label">Jumlah Graduan</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-hadir" id="totalHadir">0</div>
                <div class="stat-label">Tetamu Hadir</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-tidak-hadir" id="totalTidakHadir">0</div>
                <div class="stat-label">Tetamu Tidak Hadir</div>
            </div>
            <div class="stat-card">
                <div class="stat-number stat-pending" id="totalPending">0</div>
                <div class="stat-label">Belum Check-In</div>
            </div>
        </div>

        <!-- MAIN INTERFACE -->
        <div class="main-interface">
            <!-- Graduate Search Section -->
            <div class="card">
                <h2 class="section-title">Carian Graduan</h2>
                
                <div class="search-bar">
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Cari nama graduan, no. badan, atau platun..." maxlength="100" disabled>
                    <button class="search-btn" onclick="performSearch()" disabled>🔍</button>
                </div>
                
                <div class="filter-buttons" id="filterButtons">
                    <button class="filter-btn active" data-filter="semua">Semua</button>
                    <button class="filter-btn" data-filter="pending">Belum Check-In</button>
                    <button class="filter-btn" data-filter="hadir">Tetamu Hadir</button>
                    <button class="filter-btn" data-filter="tidak-hadir">Tetamu Tidak Hadir</button>
                </div>
                
                <div class="graduate-list" id="graduateList">
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>Tiada data graduan. Sila import data dari fail Excel.</p>
                    </div>
                </div>
            </div>

            <!-- Check-In Form Section -->
            <div class="card">
                <h2 class="section-title">Check-In Tetamu</h2>
                
                <div class="success-message" id="successMessage">
                    Kehadiran tetamu berjaya dikemaskini!
                </div>
                
                <div id="noSelection" class="no-selection">
                    <div style="font-size: 4em; margin-bottom: 15px;">📝</div>
                    <p>Sila import data graduan terlebih dahulu, kemudian pilih graduan dari senarai untuk mula check-in tetamu jemputan.</p>
                </div>

                <div class="checkin-form" id="checkinForm">
                    <div class="graduate-info" id="selectedGraduateInfo"></div>
                    
                    <div class="guest-section">
                        <div class="guest-header">
                            <div class="guest-title">Tetamu Jemputan</div>
                            <div class="attendance-toggle">
                                <button class="toggle-option" id="hadirBtn" onclick="updateAttendance('hadir')">
                                    Hadir
                                </button>
                                <button class="toggle-option" id="tidakHadirBtn" onclick="updateAttendance('tidak hadir')">
                                    Tidak Hadir
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="namaTetamu">Nama Tetamu Jemputan</label>
                            <input type="text" id="namaTetamu" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="hubungan">Hubungan</label>
                            <input type="text" id="hubungan" readonly>
                        </div>
                        
                        <div class="replacement-section" id="replacementSection">
                            <div class="form-group">
                                <label for="namaPengganti">
                                    Nama Pengganti (sekiranya tetamu jemputan tidak dapat hadir)
                                </label>
                                <input type="text" id="namaPengganti" 
                                       placeholder="Masukkan nama pengganti..." maxlength="100">
                            </div>
                            <div class="form-group">
                                <label for="hubunganPengganti">
                                    Hubungan Pengganti
                                </label>
                                <select id="hubunganPengganti">
                                    <option value="">Sila pilih hubungan</option>
                                    <option value="Bapa">Bapa</option>
                                    <option value="Ibu">Ibu</option>
                                    <option value="Adik-beradik">Adik-beradik</option>
                                    <option value="Pasangan">Pasangan</option>
                                    <option value="Saudara">Saudara</option>
                                    <option value="Rakan">Rakan</option>
                                    <option value="Lain-lain">Lain-lain</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button class="submit-btn" onclick="saveCheckIn()" id="submitBtn">
                        💾 KEMASKINI KEHADIRAN
                    </button>
                </div>
            </div>
        </div>

        <!-- ATTENDANCE LOG -->
        <div class="card attendance-log">
            <h2 class="section-title">Log Kehadiran Tetamu</h2>
            <div style="overflow-x: auto;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Masa</th>
                            <th>Graduan</th>
                            <th>No. Badan</th>
                            <th>Platun</th>
                            <th>Tetamu</th>
                            <th>Hubungan</th>
                            <th>Status</th>
                            <th>Pengganti</th>
                            <th>Hubungan Pengganti</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceLog">
                        <tr>
                            <td colspan="9" style="text-align: center; color: #6c757d; font-style: italic; padding: 30px;">
                                Tiada rekod kehadiran lagi. Sila check-in tetamu untuk lihat log.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SheetJS Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ============================================
        // ONLINE CONVOCATION SYSTEM - MULTI-USER
        // ============================================
        
        // Global variables
        let graduates = [];
        let selectedGraduate = null;
        let attendanceHistory = [];
        let currentFilter = 'semua';
        let previewData = null;
        let searchTimeout = null;
        let isProcessing = false;
        let systemReady = false;
        let googleSheetLink = '';
        let googleSheetId = '';

        // Constants
        const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
        const ALLOWED_FILE_TYPES = ['.xlsx', '.xls'];
        const DEBOUNCE_DELAY = 300;
        const STUDENT_ID_PATTERN = /^[A-Za-z]\d+$/;

        // HTML Sanitization
        function sanitizeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Input validation
        function validateStudentId(id) {
            return STUDENT_ID_PATTERN.test(id);
        }

        function validateFileSize(file) {
            return file.size <= MAX_FILE_SIZE;
        }

        function validateFileType(file) {
            const extension = '.' + file.name.split('.').pop().toLowerCase();
            return ALLOWED_FILE_TYPES.includes(extension);
        }

        // Safe DOM element creation
        function createSafeElement(tag, className, textContent) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (textContent) element.textContent = textContent;
            return element;
        }

        // Message display
        function showMessage(type, message, autoHide = true) {
            const statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) return;

            statusDiv.className = 'status-message status-' + type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            if (autoHide) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showConnectionStatus(type, message) {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) return;

            statusDiv.className = 'connection-status connection-' + type;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // Loading state management
        function setLoadingState(isLoading) {
            const elements = {
                loading: document.getElementById('loadingDiv'),
                uploadBtn: document.getElementById('uploadBtn'),
                exportBtn: document.getElementById('exportBtn'),
                submitBtn: document.getElementById('submitBtn')
            };

            for (const key in elements) {
                const el = elements[key];
                if (el) {
                    if (isLoading) {
                        el.disabled = true;
                        if (el.classList.contains('loading')) {
                            el.style.display = 'block';
                        }
                    } else {
                        el.disabled = false;
                        if (el.classList.contains('loading')) {
                            el.style.display = 'none';
                        }
                    }
                }
            }
            isProcessing = isLoading;
        }

        // Progress bar update
        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (progressBar && progressFill) {
                if (percent > 0) {
                    progressBar.style.display = 'block';
                    progressFill.style.width = percent + '%';
                } else {
                    progressBar.style.display = 'none';
                }
            }
        }

        // System ready check
        function checkSystemReady() {
            if (!systemReady) {
                showMessage('warning', 'Sistem masih memuat. Sila tunggu sebentar...');
                return false;
            }
            return true;
        }

        // Connect to Google Sheets
        function connectToSheet() {
            const sheetLink = document.getElementById('sheetLink').value.trim();
            if (!sheetLink) {
                showConnectionStatus('error', 'Sila masukkan pautan Google Sheets');
                return;
            }

            // Extract Google Sheets ID from URL
            const match = sheetLink.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!match || !match[1]) {
                showConnectionStatus('error', 'Pautan Google Sheets tidak sah');
                return;
            }

            googleSheetLink = sheetLink;
            googleSheetId = match[1];
            
            setLoadingState(true);
            showConnectionStatus('warning', 'Menyambung ke Google Sheets...');

            // Load data from Google Sheets
            loadDataFromGoogleSheet(googleSheetId);
        }

        // Load data from Google Sheets using CSV export
        function loadDataFromGoogleSheet(sheetId) {
            // URLs for Google Sheets in CSV format (public)
            const graduatesUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Graduates`;
            const attendanceUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Attendance`;
            
            // Load graduates data
            fetchCsv(graduatesUrl)
                .then(csvData => {
                    graduates = parseCsvData(csvData);
                    return fetchCsv(attendanceUrl);
                })
                .then(csvData => {
                    attendanceHistory = parseAttendanceData(csvData);
                    showConnectionStatus('success', 'Data berjaya dimuat dari Google Sheets!');
                    renderGraduates();
                    refreshAttendanceLog();
                    calculateStatistics();
                    
                    // Enable all functions
                    document.getElementById('searchInput').disabled = false;
                    document.querySelector('.search-btn').disabled = false;
                    document.getElementById('exportBtn').disabled = false;
                    
                    systemReady = true;
                    setLoadingState(false);
                })
                .catch(error => {
                    showConnectionStatus('error', 'Ralat memuat data: ' + error.message);
                    setLoadingState(false);
                });
        }

        // Fetch CSV data
        function fetchCsv(url) {
            return fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Rangkaian tidak berfungsi');
                    return response.text();
                });
        }

        // Parse CSV data for graduates
        function parseCsvData(csvData) {
            const rows = csvData.split('\n').slice(1); // Skip header
            const graduates = [];
            
            for (let i = 0; i < rows.length; i++) {
                // Handle CSV with quotes and commas properly
                const cells = rows[i].split(',').map(cell => 
                    cell.trim().replace(/^"|"$/g, ''));
                
                if (cells.length >= 5 && cells[1]) { // Ensure there's a graduate name
                    graduates.push({
                        id: cells[0] || i + 1,
                        namaGraduan: cells[1],
                        noBadan: cells[2],
                        platun: cells[3],
                        tetamu: {
                            namaTetamu: cells[4],
                            hubungan: cells[5],
                            status: cells[6] || 'pending',
                            namaPengganti: cells[7] || '',
                            hubunganPengganti: cells[8] || ''
                        }
                    });
                }
            }
            
            return graduates;
        }

        // Parse CSV data for attendance
        function parseAttendanceData(csvData) {
            const rows = csvData.split('\n').slice(1); // Skip header
            const attendance = [];
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].split(',').map(cell => 
                    cell.trim().replace(/^"|"$/g, ''));
                
                if (cells.length >= 9 && cells[0]) { // Ensure there's a timestamp
                    attendance.push({
                        time: cells[0],
                        graduanId: cells[1],
                        graduan: cells[2],
                        noBadan: cells[3],
                        platun: cells[4],
                        tetamu: cells[5],
                        hubungan: cells[6],
                        status: cells[7],
                        pengganti: cells[8] || '-',
                        hubunganPengganti: cells[9] || '-'
                    });
                }
            }
            
            return attendance;
        }

        // Save data to Google Sheets using FormSubmit
        function saveToGoogleSheet(data, sheetName) {
            if (!googleSheetLink) {
                showMessage('error', 'Sila sambung ke Google Sheets terlebih dahulu');
                return;
            }
            
            // This is a simplified version - in a real implementation,
            // you would need to create a Google Apps Script to handle this
            showMessage('warning', 'Penyimpanan ke Google Sheets memerlukan setup Google Apps Script');
        }

        // Excel template download
        function downloadTemplate() {
            if (!checkSystemReady() || isProcessing) return;

            try {
                setLoadingState(true);
                updateProgress(25);

                if (typeof XLSX === 'undefined') {
                    throw new Error('Excel library tidak dimuat. Sila refresh halaman.');
                }

                const templateData = [
                    ['Nama Graduan', 'No Badan', 'Platun', 'Nama Tetamu', 'Hubungan', 'Nama Pengganti', 'Hubungan Pengganti'],
                    ['Ahmad Bin Hassan', 'G2021123001', 'Platun A', 'Fatimah Binti Ahmad', 'Ibu', 'Hassan Bin Ahmad', 'Bapa'],
                    ['Siti Aminah Binti Ali', 'G2021123002', 'Platun B', 'Ali Bin Abdullah', 'Bapa', 'Zainab Binti Ali', 'Kakak'],
                    ['Muhammad Faiz Bin Omar', 'G2021123003', 'Platun A', 'Omar Bin Hassan', 'Bapa', '', ''],
                    ['Nurul Huda Binti Zainal', 'G2021123004', 'Platun C', 'Zainal Bin Ibrahim', 'Bapa', 'Khadijah Binti Zainal', 'Ibu']
                ];

                updateProgress(50);

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(templateData);

                ws['!cols'] = [
                    {wch: 25}, {wch: 15}, {wch: 12}, 
                    {wch: 25}, {wch: 12}, {wch: 25}, {wch: 20}
                ];

                updateProgress(75);
                XLSX.utils.book_append_sheet(wb, ws, "Data Graduan");
                updateProgress(90);

                const filename = "template_convocation.xlsx";
                
                if (typeof XLSX.writeFile === 'function') {
                    XLSX.writeFile(wb, filename);
                    updateProgress(100);
                    showMessage('success', 'Template Excel berjaya dimuat turun!');
                } else {
                    const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                    const blob = new Blob([wbout], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
                    
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    updateProgress(100);
                    showMessage('success', 'Template Excel berjaya dimuat turun!');
                }
                
                setTimeout(() => {
                    updateProgress(0);
                    setLoadingState(false);
                }, 1000);

            } catch (error) {
                console.error('Error creating template:', error);
                updateProgress(0);
                setLoadingState(false);
                showMessage('error', 'Ralat mencipta template Excel. Sila cuba lagi.');
            }
        }

        function showFormatExample() {
            if (!checkSystemReady()) return;
            const example = "FORMAT EXCEL YANG DIPERLUKAN:\n\nColumn A: Nama Graduan\nColumn B: No Badan (Format: G28439)\nColumn C: Platun\nColumn D: Nama Tetamu\nColumn E: Hubungan\nColumn F: Nama Pengganti (optional)\nColumn G: Hubungan Pengganti (optional)";
            alert(example);
        }

        function selectFile() {
            if (!checkSystemReady() || isProcessing) return;
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.click();
        }

        function processFile(file) {
            if (!checkSystemReady() || isProcessing) return;

            if (!validateFileType(file)) {
                showMessage('error', 'Sila pilih fail Excel (.xlsx atau .xls) sahaja!');
                return;
            }

            if (!validateFileSize(file)) {
                showMessage('error', 'Saiz fail terlalu besar! Maksimum: ' + (MAX_FILE_SIZE / (1024 * 1024)) + 'MB');
                return;
            }

            setLoadingState(true);
            updateProgress(10);
            showMessage('warning', 'Sedang memproses fail Excel...', false);

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    updateProgress(40);
                    
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellFormula: false,
                        cellHTML: false
                    });

                    updateProgress(60);

                    const firstSheetName = workbook.SheetNames[0];
                    if (!firstSheetName) {
                        throw new Error('Fail Excel tidak mempunyai worksheet yang sah.');
                    }

                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '',
                        blankrows: false
                    });

                    updateProgress(80);

                    if (jsonData.length < 2) {
                        throw new Error('Fail Excel perlu mempunyai sekurang-kurangnya header dan 1 baris data.');
                    }

                    previewData = parseExcelData(jsonData);
                    
                    updateProgress(100);
                    
                    setTimeout(() => {
                        displayPreview(previewData);
                        updateProgress(0);
                        setLoadingState(false);
                    }, 500);

                } catch (error) {
                    console.error('Excel processing error:', error);
                    showMessage('error', 'Ralat membaca fail Excel: ' + error.message);
                    updateProgress(0);
                    setLoadingState(false);
                }
            };

            reader.onerror = function() {
                showMessage('error', 'Ralat membaca fail. Sila cuba lagi.');
                updateProgress(0);
                setLoadingState(false);
            };

            reader.readAsArrayBuffer(file);
        }

        function parseExcelData(jsonData) {
            const headers = jsonData[0];
            const rows = jsonData.slice(1);

            const requiredHeaders = ['Nama Graduan', 'No Badan', 'Platun', 'Nama Tetamu', 'Hubungan'];
            const headerMap = {};

            for (let i = 0; i < headers.length; i++) {
                const cleanHeader = headers[i] ? headers[i].toString().trim() : '';
                headerMap[cleanHeader] = i;
            }

            for (let j = 0; j < requiredHeaders.length; j++) {
                if (headerMap[requiredHeaders[j]] === undefined) {
                    throw new Error('Header yang hilang: ' + requiredHeaders[j]);
                }
            }

            const processedData = [];
            const errors = [];
            let idCounter = graduates.length + 1; // Start from current length + 1

            for (let k = 0; k < rows.length; k++) {
                const row = rows[k];
                const rowNum = k + 2;

                if (!row || row.length === 0 || !row[headerMap['Nama Graduan']]) {
                    continue;
                }

                try {
                    const namaGraduan = (row[headerMap['Nama Graduan']] || '').toString().trim();
                    const noBadan = (row[headerMap['No Badan']] || '').toString().trim();
                    const platun = (row[headerMap['Platun']] || '').toString().trim();
                    const namaTetamu = (row[headerMap['Nama Tetamu']] || '').toString().trim();
                    const hubungan = (row[headerMap['Hubungan']] || '').toString().trim();
                    const namaPengganti = (row[headerMap['Nama Pengganti']] || '').toString().trim();
                    const hubunganPengganti = (row[headerMap['Hubungan Pengganti']] || '').toString().trim();

                    if (!namaGraduan || !noBadan || !platun || !namaTetamu || !hubungan) {
                        errors.push('Baris ' + rowNum + ': Data tidak lengkap');
                        continue;
                    }

                    if (!validateStudentId(noBadan)) {
                        errors.push('Baris ' + rowNum + ': No Badan tidak sah (Format: G28439): ' + noBadan);
                        continue;
                    }

                    const duplicate = graduates.find(g => g.noBadan === noBadan) || 
                                  processedData.find(g => g.noBadan === noBadan);
                    if (duplicate) {
                        errors.push('Baris ' + rowNum + ': No Badan sudah wujud: ' + noBadan);
                        continue;
                    }

                    if (namaGraduan.length > 100 || namaTetamu.length > 100) {
                        errors.push('Baris ' + rowNum + ': Nama terlalu panjang (maksimum 100 aksara)');
                        continue;
                    }

                    processedData.push({
                        id: idCounter++,
                        namaGraduan: sanitizeHtml(namaGraduan),
                        noBadan: sanitizeHtml(noBadan),
                        platun: sanitizeHtml(platun),
                        tetamu: {
                            namaTetamu: sanitizeHtml(namaTetamu),
                            hubungan: sanitizeHtml(hubungan),
                            namaPengganti: sanitizeHtml(namaPengganti),
                            hubunganPengganti: sanitizeHtml(hubunganPengganti),
                            status: 'pending'
                        }
                    });

                } catch (error) {
                    errors.push('Baris ' + rowNum + ': ' + error.message);
                }
            }

            if (errors.length > 0) {
                let errorMsg = 'Terdapat ' + errors.length + ' ralat:\n' + errors.slice(0, 5).join('\n');
                if (errors.length > 5) {
                    errorMsg += '\n... dan ' + (errors.length - 5) + ' lagi.';
                }
                throw new Error(errorMsg);
            }

            if (processedData.length === 0) {
                throw new Error('Tiada data yang sah dijumpai dalam fail Excel.');
            }

            return processedData;
        }

        function displayPreview(data) {
            const previewSection = document.getElementById('previewSection');
            const previewTable = document.getElementById('previewTable');

            if (!previewSection || !previewTable) return;

            const previewRows = data.slice(0, 5);
            previewTable.innerHTML = '';

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            ['Nama Graduan', 'No. Badan', 'Platun', 'Nama Tetamu', 'Hubungan', 'Nama Pengganti', 'Hubungan Pengganti'].forEach(header => {
                const th = createSafeElement('th', '', header);
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            
            previewRows.forEach(item => {
                const row = document.createElement('tr');
                
                [
                    item.namaGraduan,
                    item.noBadan,
                    item.platun,
                    item.tetamu.namaTetamu,
                    item.tetamu.hubungan,
                    item.tetamu.namaPengganti || '-',
                    item.tetamu.hubunganPengganti || '-'
                ].forEach(cellData => {
                    const td = createSafeElement('td', '', cellData);
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            });

            previewTable.appendChild(tbody);

            showMessage('success', 'Berjaya baca ' + data.length + ' rekod dari fail Excel. Sila semak preview dan klik "Import Data" untuk teruskan.');
            previewSection.style.display = 'block';
        }

        function importData() {
            if (!checkSystemReady() || !previewData || isProcessing) {
                showMessage('error', 'Tiada data untuk diimport!');
                return;
            }

            try {
                setLoadingState(true);
                graduates = graduates.concat(previewData);
                renderGraduates();
                calculateStatistics();
                
                document.getElementById('previewSection').style.display = 'none';
                const fileInput = document.getElementById('fileInput');
                if (fileInput) fileInput.value = '';
                
                showMessage('success', 'Berjaya import ' + previewData.length + ' rekod graduan baru ke dalam sistem!');
                previewData = null;
                
            } catch (error) {
                showMessage('error', 'Ralat importing data: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        }

        function cancelPreview() {
            if (!checkSystemReady() || isProcessing) return;
            
            document.getElementById('previewSection').style.display = 'none';
            const fileInput = document.getElementById('fileInput');
            if (fileInput) fileInput.value = '';
            previewData = null;
            showMessage('warning', 'Import dibatalkan.');
        }

        function renderGraduates(graduateList = graduates) {
            const container = document.getElementById('graduateList');
            if (!container) return;

            container.innerHTML = '';

            if (graduateList.length === 0) {
                const emptyState = createSafeElement('div', 'empty-state');
                emptyState.innerHTML = `
                    <div class="empty-state-icon">📊</div>
                    <p>Tiada data graduan. Sila import data dari fail Excel.</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            let filteredGraduates = graduateList;
            if (currentFilter !== 'semua') {
                filteredGraduates = graduateList.filter(graduate => {
                    switch(currentFilter) {
                        case 'pending': return graduate.tetamu.status === 'pending';
                        case 'hadir': return graduate.tetamu.status === 'hadir';
                        case 'tidak-hadir': return graduate.tetamu.status === 'tidak hadir';
                        default: return true;
                    }
                });
            }

            if (filteredGraduates.length === 0) {
                const emptyState = createSafeElement('div', 'empty-state');
                emptyState.innerHTML = `
                    <div class="empty-state-icon">🔍</div>
                    <p>Tiada graduan yang sepadan dengan filter yang dipilih.</p>
                `;
                container.appendChild(emptyState);
                return;
            }

            const fragment = document.createDocumentFragment();

            filteredGraduates.forEach(graduate => {
                const graduateDiv = createSafeElement('div', 'graduate-item');
                
                graduateDiv.addEventListener('click', () => {
                    chooseGraduate(graduate);
                });
                
                const statusClass = 'status-' + graduate.tetamu.status.replace(' ', '-');
                const statusIndicator = createSafeElement('div', 'status-indicator ' + statusClass, graduate.tetamu.status.toUpperCase());
                
                const nameDiv = createSafeElement('div', 'graduate-name', graduate.namaGraduan);
                
                const detailsDiv = createSafeElement('div', 'graduate-details');
                let detailsHTML = 
                    '<strong>No. Badan:</strong> ' + sanitizeHtml(graduate.noBadan) + '<br>' +
                    '<strong>Platun:</strong> ' + sanitizeHtml(graduate.platun) + '<br>' +
                    '<strong>Tetamu:</strong> ' + sanitizeHtml(graduate.tetamu.namaTetamu) + ' (' + sanitizeHtml(graduate.tetamu.hubungan) + ')';
                
                // Add replacement info if available
                if (graduate.tetamu.namaPengganti && graduate.tetamu.status === 'hadir') {
                    detailsHTML += '<br><strong>Pengganti:</strong> ' + sanitizeHtml(graduate.tetamu.namaPengganti) + 
                                  ' (' + sanitizeHtml(graduate.tetamu.hubunganPengganti) + ')';
                }
                
                detailsDiv.innerHTML = detailsHTML;
                
                graduateDiv.appendChild(statusIndicator);
                graduateDiv.appendChild(nameDiv);
                graduateDiv.appendChild(detailsDiv);
                
                fragment.appendChild(graduateDiv);
            });

            container.appendChild(fragment);
            calculateStatistics();
        }

        function performSearch() {
            if (!checkSystemReady() || graduates.length === 0) return;

            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('searchInput');
                if (!searchInput) return;
                
                const searchTerm = searchInput.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    renderGraduates();
                    return;
                }
                
                const filteredGraduates = graduates.filter(graduate => {
                    return graduate.namaGraduan.toLowerCase().includes(searchTerm) ||
                           graduate.noBadan.toLowerCase().includes(searchTerm) ||
                           graduate.platun.toLowerCase().includes(searchTerm) ||
                           graduate.tetamu.namaTetamu.toLowerCase().includes(searchTerm) ||
                           (graduate.tetamu.namaPengganti && graduate.tetamu.namaPengganti.toLowerCase().includes(searchTerm));
                });
                
                renderGraduates(filteredGraduates);
            }, DEBOUNCE_DELAY);
        }

        function chooseGraduate(graduate) {
            if (!checkSystemReady()) return;

            selectedGraduate = graduate;

            document.querySelectorAll('.graduate-item').forEach(item => {
                item.classList.remove('selected');
            });

            event.currentTarget.classList.add('selected');

            const noSelection = document.getElementById('noSelection');
            const checkinForm = document.getElementById('checkinForm');
            
            if (noSelection) noSelection.style.display = 'none';
            if (checkinForm) {
                checkinForm.classList.add('active');
                checkinForm.style.display = 'block';
            }

            const graduateInfo = document.getElementById('selectedGraduateInfo');
            if (graduateInfo) {
                graduateInfo.innerHTML = 
                    '<h3>' + sanitizeHtml(graduate.namaGraduan) + '</h3>' +
                    '<p><strong>No. Badan:</strong> ' + sanitizeHtml(graduate.noBadan) + '</p>' +
                    '<p><strong>Platun:</strong> ' + sanitizeHtml(graduate.platun) + '</p>';
            }

            const namaTetamu = document.getElementById('namaTetamu');
            const hubungan = document.getElementById('hubungan');
            const namaPengganti = document.getElementById('namaPengganti');
            const hubunganPengganti = document.getElementById('hubunganPengganti');

            if (namaTetamu) namaTetamu.value = graduate.tetamu.namaTetamu;
            if (hubungan) hubungan.value = graduate.tetamu.hubungan;
            if (namaPengganti) namaPengganti.value = graduate.tetamu.namaPengganti || '';
            if (hubunganPengganti) hubunganPengganti.value = graduate.tetamu.hubunganPengganti || '';

            refreshToggleButtons(graduate.tetamu.status);

            const replacementSection = document.getElementById('replacementSection');
            if (replacementSection) {
                if (graduate.tetamu.status === 'tidak hadir') {
                    replacementSection.classList.add('active');
                } else {
                    replacementSection.classList.remove('active');
                }
            }

            // Ensure submit button is always visible
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.style.display = 'block';
                submitBtn.style.visibility = 'visible';
                submitBtn.disabled = false;
            }
        }

        function refreshToggleButtons(status) {
            const hadirBtn = document.getElementById('hadirBtn');
            const tidakHadirBtn = document.getElementById('tidakHadirBtn');

            if (!hadirBtn || !tidakHadirBtn) return;

            hadirBtn.classList.remove('active', 'inactive');
            tidakHadirBtn.classList.remove('active', 'inactive');

            if (status === 'hadir') {
                hadirBtn.classList.add('active');
                tidakHadirBtn.classList.remove('active');
            } else if (status === 'tidak hadir') {
                tidakHadirBtn.classList.add('inactive');
                hadirBtn.classList.remove('inactive');
            }
        }

        function updateAttendance(status) {
            if (!checkSystemReady() || !selectedGraduate) return;

            selectedGraduate.tetamu.status = status;
            refreshToggleButtons(status);

            const replacementSection = document.getElementById('replacementSection');
            if (replacementSection) {
                if (status === 'tidak hadir') {
                    replacementSection.classList.add('active');
                } else {
                    replacementSection.classList.remove('active');
                }
            }

            renderGraduates();
        }

        function saveCheckIn() {
            if (!checkSystemReady() || !selectedGraduate || isProcessing) return;

            try {
                setLoadingState(true);

                const namaPenggantiInput = document.getElementById('namaPengganti');
                const namaPengganti = namaPenggantiInput ? namaPenggantiInput.value.trim() : '';

                const hubunganPenggantiInput = document.getElementById('hubunganPengganti');
                const hubunganPengganti = hubunganPenggantiInput ? hubunganPenggantiInput.value.trim() : '';

                if (namaPengganti.length > 100) {
                    showMessage('error', 'Nama pengganti terlalu panjang (maksimum 100 aksara)');
                    return;
                }

                // If there's a replacement, consider the attendance as "hadir"
                if (namaPengganti && selectedGraduate.tetamu.status === 'tidak hadir') {
                    selectedGraduate.tetamu.status = 'hadir';
                    refreshToggleButtons('hadir');
                }

                selectedGraduate.tetamu.namaPengganti = sanitizeHtml(namaPengganti);
                selectedGraduate.tetamu.hubunganPengganti = sanitizeHtml(hubunganPengganti);

                const now = new Date();
                const timeString = now.toLocaleString('ms-MY');

                // Remove any existing entry for this graduate
                attendanceHistory = attendanceHistory.filter(entry => {
                    return entry.graduanId !== selectedGraduate.id;
                });

                if (selectedGraduate.tetamu.status !== 'pending') {
                    attendanceHistory.unshift({
                        time: timeString,
                        graduanId: selectedGraduate.id,
                        graduan: selectedGraduate.namaGraduan,
                        noBadan: selectedGraduate.noBadan,
                        platun: selectedGraduate.platun,
                        tetamu: selectedGraduate.tetamu.namaTetamu,
                        hubungan: selectedGraduate.tetamu.hubungan,
                        status: selectedGraduate.tetamu.status,
                        pengganti: selectedGraduate.tetamu.namaPengganti || '-',
                        hubunganPengganti: selectedGraduate.tetamu.hubunganPengganti || '-'
                    });
                }

                // Save to Google Sheets
                saveToGoogleSheet(attendanceHistory[0], 'Attendance');

                const successMessage = document.getElementById('successMessage');
                if (successMessage) {
                    successMessage.style.display = 'block';
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                }

                renderGraduates();
                refreshAttendanceLog();
                calculateStatistics();

            } catch (error) {
                showMessage('error', 'Ralat menyimpan data: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        }

        function refreshAttendanceLog() {
            const container = document.getElementById('attendanceLog');
            if (!container) return;

            container.innerHTML = '';

            if (attendanceHistory.length === 0) {
                const row = document.createElement('tr');
                const cell = createSafeElement('td', '', 'Tiada rekod kehadiran lagi. Sila check-in tetamu untuk lihat log.');
                cell.setAttribute('colspan', '9');
                cell.style.textAlign = 'center';
                cell.style.color = '#6c757d';
                cell.style.fontStyle = 'italic';
                cell.style.padding = '30px';
                row.appendChild(cell);
                container.appendChild(row);
                return;
            }

            const fragment = document.createDocumentFragment();

            attendanceHistory.forEach(entry => {
                const row = document.createElement('tr');

                const cells = [
                    entry.time,
                    entry.graduan,
                    entry.noBadan,
                    entry.platun,
                    entry.tetamu,
                    entry.hubungan,
                    entry.status,
                    entry.pengganti,
                    entry.hubunganPengganti
                ];

                cells.forEach((cellData, index) => {
                    const cell = document.createElement('td');
                    
                    if (index === 6) {
                        const statusBadge = createSafeElement('span', 'status-badge status-' + cellData.replace(' ', '-'), cellData);
                        cell.appendChild(statusBadge);
                    } else {
                        cell.textContent = cellData;
                    }
                    
                    row.appendChild(cell);
                });

                fragment.appendChild(row);
            });

            container.appendChild(fragment);
        }

        function calculateStatistics() {
            const totalGraduates = graduates.length;
            let totalHadir = 0;
            let totalTidakHadir = 0;
            let totalPending = 0;

            graduates.forEach(graduate => {
                switch(graduate.tetamu.status) {
                    case 'hadir':
                        totalHadir++;
                        break;
                    case 'tidak hadir':
                        totalTidakHadir++;
                        break;
                    default:
                        totalPending++;
                }
            });

            const elements = {
                totalGraduates: document.getElementById('totalGraduates'),
                totalHadir: document.getElementById('totalHadir'),
                totalTidakHadir: document.getElementById('totalTidakHadir'),
                totalPending: document.getElementById('totalPending')
            };

            if (elements.totalGraduates) elements.totalGraduates.textContent = totalGraduates;
            if (elements.totalHadir) elements.totalHadir.textContent = totalHadir;
            if (elements.totalTidakHadir) elements.totalTidakHadir.textContent = totalTidakHadir;
            if (elements.totalPending) elements.totalPending.textContent = totalPending;

            const exportBtn = document.getElementById('exportBtn');
            if (exportBtn) {
                exportBtn.disabled = attendanceHistory.length === 0;
            }
        }

        function exportData() {
            if (!checkSystemReady() || attendanceHistory.length === 0 || isProcessing) {
                showMessage('warning', 'Tiada data untuk export. Sila check-in tetamu terlebih dahulu.');
                return;
            }

            try {
                setLoadingState(true);

                const headers = ['Masa', 'Graduan', 'No. Badan', 'Platun', 'Tetamu', 'Hubungan', 'Status', 'Pengganti', 'Hubungan Pengganti'];
                let csvContent = headers.join(',') + '\n';

                attendanceHistory.forEach(entry => {
                    const row = [
                        '"' + entry.time.replace(/"/g, '""') + '"',
                        '"' + entry.graduan.replace(/"/g, '""') + '"',
                        '"' + entry.noBadan.replace(/"/g, '""') + '"',
                        '"' + entry.platun.replace(/"/g, '""') + '"',
                        '"' + entry.tetamu.replace(/"/g, '""') + '"',
                        '"' + entry.hubungan.replace(/"/g, '""') + '"',
                        '"' + entry.status.replace(/"/g, '""') + '"',
                        '"' + entry.pengganti.replace(/"/g, '""') + '"',
                        '"' + entry.hubunganPengganti.replace(/"/g, '""') + '"'
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'kehadiran_convocation.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('success', 'Data berjaya diexport!');
                
            } catch (error) {
                console.error('Export error:', error);
                showMessage('error', 'Ralat export data: ' + error.message);
            } finally {
                setLoadingState(false);
            }
        }

        // Event handlers
        function handleFileSelect(e) {
            if (isProcessing) return;
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handleFilterClick(e) {
            if (!e.target.classList.contains('filter-btn') || isProcessing || graduates.length === 0) return;

            currentFilter = e.target.dataset.filter;

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            e.target.classList.add('active');

            renderGraduates();
        }

        function handleSearchInput() {
            if (isProcessing || graduates.length === 0) return;
            performSearch();
        }

        function handleSearchKeyPress(e) {
            if (e.key === 'Enter' && !isProcessing && graduates.length > 0) {
                performSearch();
            }
        }

        // System initialization
        function initializeSystem() {
            try {
                console.log('Initializing online convocation system...');

                // Setup event listeners
                const fileInput = document.getElementById('fileInput');
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }

                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', handleSearchInput);
                    searchInput.addEventListener('keypress', handleSearchKeyPress);
                }

                const filterContainer = document.getElementById('filterButtons');
                if (filterContainer) {
                    filterContainer.addEventListener('click', handleFilterClick);
                }

                // Setup drag and drop
                const uploadArea = document.getElementById('uploadArea');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dragover');
                    });
                    
                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dragover');
                    });
                    
                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dragover');
                        
                        if (e.dataTransfer.files.length) {
                            processFile(e.dataTransfer.files[0]);
                        }
                    });
                }

                console.log('System initialized! Ready to connect to Google Sheets.');
                
            } catch (error) {
                console.error('System initialization error:', error);
                showMessage('error', 'Ralat memulakan sistem: ' + error.message);
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeSystem);
    </script>
</body>
</html>
